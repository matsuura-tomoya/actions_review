name: 'Review with AI'
on: 
  pull_request:
  
jobs:
  review:
    permissions:
      models: read
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
 
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46

      # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¸€æ™‚çš„ã«ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      - name: Setup review file
        if: steps.changed-files.outputs.all_changed_files != ''
        run: echo "### âœ¨ AIã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ" > review_comment.txt

      # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ãƒ«ãƒ¼ãƒ—å‡¦ç†
      - name: Review each changed file with AI
        if: steps.changed-files.outputs.all_changed_files != ''
        # strategy.matrix ã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ã‚¸ãƒ§ãƒ–ã‚’ä¸¦åˆ—å®Ÿè¡Œ
        strategy:
          matrix:
            file: ${{ fromJson(steps.changed-files.outputs.all_changed_files_json) }}
        run: |
          echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«: ${{ matrix.file }}"
          # AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
          response=$(gh ai -s "ã‚ãªãŸã¯ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚" < "${{ matrix.file }}")
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
          echo -e "\n\n---\n\n#### ğŸ“„ **${{ matrix.file }}** ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼š\n\n$response" >> review_comment.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 1ã¤ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦PRã«æŠ•ç¨¿ã™ã‚‹
      - name: Comment on PR
        if: steps.changed-files.outputs.all_changed_files != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file review_comment.txt