name: 'Review with AI'
on: 
  pull_request:
  
jobs:
  review:
    permissions:
      # gh ai ã‚’ä½¿ã†å ´åˆã¯ models: read ãŒå¿…è¦
      models: read
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
 
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46

      # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¸€æ™‚çš„ã«ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
      - name: Setup review file
        if: steps.changed-files.outputs.all_changed_files != ''
        run: echo "### âœ¨ AIã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ" > review_comment.txt

      # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«ãƒ«ãƒ¼ãƒ—å‡¦ç†ã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ã¾ã¨ã‚ã‚‹
      - name: Review each changed file and build comment
        if: steps.changed-files.outputs.all_changed_files != ''
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ãšã¤ãƒ«ãƒ¼ãƒ—å‡¦ç†
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«: $file"

            # AIã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼
            response=$(gh ai -s "ã‚ãªãŸã¯ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®å†…å®¹ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚" < "$file")
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
            echo -e "\n\n---\n\n#### ğŸ“„ **$file** ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼š\n\n$response" >> review_comment.txt
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 1ã¤ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦PRã«æŠ•ç¨¿ã™ã‚‹
      - name: Comment on PR
        if: steps.changed-files.outputs.all_changed_files != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file review_comment.txt